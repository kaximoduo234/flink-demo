services:
  zookeeper:
    image: bitnami/zookeeper:latest
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    networks:
      - flink-network

  kafka:
    image: bitnami/kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_NUM_PARTITIONS=2
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_HEAP_OPTS=-Xms256m -Xmx256m
      - KAFKA_CFG_LOG_RETENTION_HOURS=6
      - KAFKA_CFG_LOG_RETENTION_BYTES=268435456
    volumes:
      - ./kafka-data:/bitnami/kafka
    depends_on:
      - zookeeper
    networks:
      - flink-network

  mysql:
    image: mysql:8.0
    container_name: mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - MYSQL_DATABASE=ods
      - MYSQL_USER=testuser
      - MYSQL_PASSWORD=testpass
      - TZ=Asia/Shanghai
    command: [
      "--character-set-server=utf8mb4",
      "--collation-server=utf8mb4_unicode_ci",
      "--log-bin=mysql-bin",
      "--binlog-format=ROW",
      "--binlog-row-image=FULL",
      "--server-id=1"
    ]
    volumes:
      - ./mysql-data:/var/lib/mysql
      - ./sql-scripts:/docker-entrypoint-initdb.d
    networks:
      - flink-network

  # zeppelin å®¹å™¨å·²ç§»é™¤ - ä½¿ç”¨ Docker å®¹å™¨ä¸­çš„ Flink SQL Gateway æ›¿ä»£

  jobmanager:
    build:
      context: .
      dockerfile: flink/Dockerfile
      args:
        - PAIMON_VERSION=1.0.0
        - FLINK_VERSION=1.20.1
      target: runtime  # æŒ‡å®šæ„å»ºç›®æ ‡é˜¶æ®µ
    image: custom-flink:1.20.1-paimon-optimized
    container_name: jobmanager
    ports:
      - "8081:8081"  # Flink Web UI
      - "6123:6123"  # Flink RPC ç«¯å£ (ç”¨äºè°ƒè¯•å’Œè¿œç¨‹è¿æ¥)
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 8
        parallelism.default: 1
        # å†…å­˜ä¼˜åŒ–é…ç½®
        jobmanager.memory.process.size: 2g
        jobmanager.memory.flink.size: 1600m
        # æ£€æŸ¥ç‚¹é…ç½®
        execution.checkpointing.interval: 60s
        state.backend: filesystem
        state.checkpoints.dir: file:///opt/flink/checkpoints
      - FLINK_ENV_JAVA_OPTS=-XX:+UseG1GC -XX:MaxGCPauseMillis=50 -XX:+UseStringDeduplication -XX:+OptimizeStringConcat
    volumes:
      - ./target:/opt/flink/usrlib:ro
      - ./checkpoints:/opt/flink/checkpoints
      - ./paimon-warehouse:/warehouse
      - ./flink-jars:/opt/flink/lib/connectors:ro  # ğŸ”¥ åªè¯»æŒ‚è½½è¿æ¥å™¨
    networks:
      - flink-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/overview"]
      interval: 15s  # ğŸ”¥ æ›´é¢‘ç¹æ£€æŸ¥
      timeout: 5s    # ğŸ”¥ æ›´å¿«è¶…æ—¶
      retries: 3
      start_period: 30s  # ğŸ”¥ å‡å°‘ç­‰å¾…æ—¶é—´

  taskmanager:
    build:
      context: .
      dockerfile: flink/Dockerfile
      args:
        - PAIMON_VERSION=1.0.0
        - FLINK_VERSION=1.20.1
      target: runtime
    image: custom-flink:1.20.1-paimon-optimized
    container_name: taskmanager
    ports:
      - "6124:6124"  # TaskManager RPC ç«¯å£ (å¯é€‰ï¼Œç”¨äºè°ƒè¯•)
    depends_on:
      jobmanager:
        condition: service_healthy  # ç­‰å¾… JobManager å¥åº·åå¯åŠ¨
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 8
        parallelism.default: 1
        # TaskManager å†…å­˜ä¼˜åŒ–
        taskmanager.memory.process.size: 4g
        taskmanager.memory.flink.size: 3200m
        taskmanager.memory.managed.fraction: 0.4
      - FLINK_ENV_JAVA_OPTS=-XX:+UseG1GC -XX:MaxGCPauseMillis=50 -XX:+UseStringDeduplication -XX:+OptimizeStringConcat
    volumes:
      - ./target:/opt/flink/usrlib:ro
      - ./checkpoints:/opt/flink/checkpoints
      - ./paimon-warehouse:/warehouse
      - ./flink-jars:/opt/flink/lib/connectors:ro  # ğŸ”¥ åªè¯»æŒ‚è½½è¿æ¥å™¨
    networks:
      - flink-network
    restart: unless-stopped

  streampark:
    image: apache/streampark:2.1.5
    container_name: streampark
    restart: always
    ports:
      - "10000:10000"  # Web UI é»˜è®¤ç«¯å£
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - FLINK_REST_URL=http://jobmanager:8081
    depends_on:
      jobmanager:
        condition: service_started  # ğŸ”¥ åªéœ€è¦æœåŠ¡å¯åŠ¨ï¼Œä¸éœ€è¦å¥åº·æ£€æŸ¥
      taskmanager:
        condition: service_started
      # ç§»é™¤ StarRocks å¼ºä¾èµ–ï¼ŒStreamPark ä¸»è¦ç®¡ç† Flink ä½œä¸š
    networks:
      - flink-network

  redis:
    image: redis:6.2
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - flink-network

  starrocks:
    image: starrocks/allin1-ubuntu:3.5.0
    container_name: starrocks
    restart: on-failure
    ports:
      - "8030:8030"   # FE HTTP UI
      - "9030:9030"   # FE MySQL æ¥å£
      - "8040:8040"   # BE Web UI
    networks:
      - flink-network
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ./starrocks-storage:/opt/starrocks-storage
    healthcheck:
      test: ["CMD", "mysql", "-h127.0.0.1", "-P9030", "-uroot", "-e", "SELECT 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Flink SQL Gateway (ä¿®æ­£ YAML é…ç½®æ ¼å¼)
  sql-gateway:
    build:
      context: .
      dockerfile: flink/Dockerfile
      args:
        - PAIMON_VERSION=1.0.0
        - FLINK_VERSION=1.20.1
      target: runtime
    image: custom-flink:1.20.1-paimon-optimized
    container_name: sql-gateway
    depends_on:
      jobmanager:
        condition: service_healthy  # å¿…é¡»ç­‰å¾…JobManagerå¥åº·
      taskmanager:
        condition: service_started  # TaskManageråªéœ€å¯åŠ¨å³å¯
    command: ["bin/sql-gateway.sh", "start-foreground"]
    ports:
      - "8083:8083"
    networks:
      - flink-network
    volumes:
      - ./target:/opt/flink/usrlib:ro
      - ./checkpoints:/opt/flink/checkpoints
      - ./paimon-warehouse:/warehouse
      - ./flink-jars:/opt/flink/lib/connectors:ro  # ğŸ”¥ åªè¯»æŒ‚è½½è¿æ¥å™¨
      - ./scripts:/opt/scripts:ro  # ğŸ”¥ æŒ‚è½½åˆå§‹åŒ–è„šæœ¬
    environment:
      - |
        FLINK_PROPERTIES=
        sql-gateway.endpoint.rest.address: 0.0.0.0
        sql-gateway.endpoint.rest.port: 8083
        execution.target: remote
        jobmanager.rpc.address: jobmanager
        jobmanager.rpc.port: 6123
        rest.address: jobmanager
        rest.port: 8081
        execution.runtime-mode: streaming
        parallelism.default: 1
        table.exec.sink.upsert-materialize: NONE
      - FLINK_ENV_JAVA_OPTS=-XX:+UseG1GC -XX:MaxGCPauseMillis=50 -XX:+UseStringDeduplication -XX:+OptimizeStringConcat
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/v1/info"]
      interval: 10s  # ğŸ”¥ æ›´é¢‘ç¹æ£€æŸ¥
      timeout: 5s    # ğŸ”¥ æ›´å¿«è¶…æ—¶
      retries: 3
      start_period: 20s  # ğŸ”¥ å‡å°‘ç­‰å¾…æ—¶é—´

  # ğŸ”¥ Catalog è‡ªåŠ¨åˆå§‹åŒ–æœåŠ¡
  catalog-init:
    build:
      context: .
      dockerfile: flink/Dockerfile
      args:
        - PAIMON_VERSION=1.0.0
        - FLINK_VERSION=1.20.1
      target: runtime
    image: custom-flink:1.20.1-paimon-optimized
    container_name: catalog-init
    depends_on:
      sql-gateway:
        condition: service_healthy  # ç­‰å¾… SQL Gateway å¯åŠ¨å®Œæˆ
    command: ["/opt/scripts/init_catalogs.sh"]
    volumes:
      - ./scripts:/opt/scripts:ro
      - ./paimon-warehouse:/warehouse
    networks:
      - flink-network
    restart: "no"  # åªè¿è¡Œä¸€æ¬¡ï¼Œå®Œæˆåé€€å‡º

networks:
  flink-network:
    driver: bridge

volumes:
  kafka-data:
  mysql-data:
  paimon-warehouse:
  starrocks-storage: